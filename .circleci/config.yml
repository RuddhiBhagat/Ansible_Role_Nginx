version: 2.1

jobs:
  test-role:
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout

      # Required for Molecule Docker driver
      - setup_remote_docker

      - run:
          name: Install Ansible + Testing Tools
          command: |
            python -m pip install --upgrade pip
            pip install ansible ansible-lint molecule molecule-docker docker

      - run:
          name: Run ansible-lint
          command: ansible-lint roles/nginx

      - run:
          name: Run Molecule tests (includes idempotency)
          command: |
            cd roles/nginx
            molecule test

  publish-role:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout

      - run:
          name: Clone internal roles repo using PAT
          command: |
            git clone https://${GITHUB_TOKEN}@github.com/RuddhiBhagat/ansible-roles-internal.git

      - run:
          name: Publish nginx role
          command: |
            rm -rf ansible-roles-internal/roles/nginx
            mkdir -p ansible-roles-internal/roles
            cp -r roles/nginx ansible-roles-internal/roles/

      - run:
          name: Commit and push
          command: |
            cd ansible-roles-internal
            git config user.email "ci@company.com"
            git config user.name "circleci"
            git add roles/nginx
            git commit -m "Publish nginx role from CI - ${CIRCLE_SHA1}" || echo "No changes to commit"
            git push origin main

workflows:
  test-and-publish:
    jobs:
      - test-role
      - publish-role:
          requires:
            - test-role
          filters:
            branches:
              only: main
